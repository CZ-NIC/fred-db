#!/bin/bash

# This script ensures that database is installed and configured properly 
# for connection of database user '@DBUSER@'. Script has to be run under 
# postgresql administrator privileges (usually as user postgres)

if [ "$USER" != "postgres" ]
then
    echo "Must be run under user 'postgres'"
    exit 1;
fi

# First check if connection is configured in pg_hba file. This file is
# located in postgresql cluster in PGDATA directory. If located elsewhere
# run this script with path to pg_hba file as first parametr

if [ "$PGDATA" = "" ]
then
    PGHBA=@PGHBADIR@/pg_hba.conf
    PGDATA=@PGDATADIR@
else
    PGHBA=$PGDATA/pg_hba.conf
fi

if [ ! -f $PGHBA ]
then
    if [ "$1" = "" -o ! -f "$1" ]
    then
        echo "Cannot locate pg_hba.conf file"
	exit 2
    else
        PGHBA=$1
    fi
fi

if grep @DBUSER@ $PGHBA >/dev/null 2>&1
then
    /bin/true
else
    # There is no evidence about user @DBUSER@ in authentication file so
    # it can be suspected that user @DBUSER@ will not be allowed to connect
    # This file will be modified to allow local connection for user
    # @DBUSER@. If this is not intended modify database access options in
    # server @DBUSER@ server configuration files to suite you needs
    sed -i '1i# Next three lines were added by script '$0' \
# to allow local connection of user @DBUSER@ to database @DBNAME@ \
local @DBNAME@ @DBUSER@ @METHOD@ \
host @DBNAME@ @DBUSER@ @CIDRIPV4@ @METHOD@ \
host @DBNAME@ @DBUSER@ @CIDRIPV6@ @METHOD@ \
' $PGHBA

    # reload new file into postgres
    @PGBINDIR@/pg_ctl reload -D$PGDATA >/dev/null 2>&1
    if [ $? -ne 0 ]
    then
	    echo "Reload of updated configuration failed, try to reload manualy"
	    exit 3
    fi
fi

prefix=@prefix@
datarootdir=@datarootdir@
STRUCTSQL=@datadir@/@PACKAGE@/structure.sql 
TABLES=$(echo "SELECT val FROM enum_parameters WHERE id=1" | 
         @PGBINDIR@/psql @DBNAME@ -U @DBUSER@ -At 2>/dev/null)
if [ "$TABLES" = "" ]; then
    @PGBINDIR@/createuser @DBUSER@ -SDR > /dev/null 2>&1
    @PGBINDIR@/createdb @DBNAME@ -O @DBUSER@ -E UTF8 > /dev/null 2>&1
    @PGBINDIR@/createlang -U postgres plpgsql @DBNAME@ > /dev/null 2>&1
    @PGBINDIR@/psql @DBNAME@ -U @DBUSER@ -f $STRUCTSQL >/dev/null 2>&1
fi
